<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>è«‹æ±‚æ›¸ç”Ÿæˆ</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'Yu Mincho', 'Hiragino Mincho ProN', 'MS PMincho', serif;
    background: #e8e8e8; color: #222;
  }

  /* ===== å…¥åŠ›ãƒ‘ãƒãƒ« ===== */
  #input-panel {
    background: #1a1a2e; color: #fff; padding: 14px 16px;
    display: flex; flex-direction: column; gap: 10px;
  }
  .input-row {
    display: flex; gap: 10px;
  }
  .input-row .field { flex: 1; }
  .input-row .field label {
    font-size: 11px; font-family: sans-serif; display: block; margin-bottom: 4px; opacity: 0.8;
  }
  .input-row .field input {
    width: 100%; padding: 10px; border: none; border-radius: 6px;
    font-size: 16px; background: #fff; color: #222;
    -webkit-appearance: none;
  }
  .btn-row { display: flex; gap: 8px; }
  .btn-row button {
    flex: 1; padding: 13px 10px; border: none; border-radius: 8px;
    font-size: 15px; font-weight: bold; cursor: pointer;
    font-family: sans-serif;
  }
  #btn-calc { background: #e94560; color: #fff; }
  #btn-save { background: #0f3460; color: #fff; }
  #btn-save:disabled { opacity: 0.35; }
  #msg { font-size: 12px; font-family: sans-serif; min-height: 16px; text-align: center; }
  #msg.ok { color: #51cf66; }
  #msg.err { color: #ff6b6b; }

  /* ===== ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ ===== */
  #preview-wrap {
    padding: 12px; display: flex; justify-content: center;
  }

  /* è«‹æ±‚æ›¸æœ¬ä½“: å›ºå®šãƒ”ã‚¯ã‚»ãƒ«ã‚µã‚¤ã‚º (A4æ¯”ç‡ 210:297 â†’ 794:1123px @96dpi) */
  #invoice {
    width: 794px; height: 1123px;
    background: #fff;
    padding: 68px 68px 50px 68px;
    position: relative;
    font-size: 14px;
    line-height: 1.6;
    transform-origin: top center;
  }

  /* ãƒ¢ãƒã‚¤ãƒ«ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚° */
  @media (max-width: 820px) {
    #preview-wrap { padding: 8px; }
    #invoice {
      /* JSã§scaleã‚’å‹•çš„ã‚»ãƒƒãƒˆ */
    }
  }

  /* ===== è«‹æ±‚æ›¸å†…éƒ¨ã‚¹ã‚¿ã‚¤ãƒ« ===== */
  .inv-title {
    text-align: center; font-size: 30px; font-weight: bold;
    letter-spacing: 14px; margin-bottom: 24px;
    border-bottom: 3px double #333; padding-bottom: 12px;
  }
  .inv-header { display: flex; justify-content: space-between; margin-bottom: 20px; }
  .inv-header-left { flex: 1; }
  .inv-header-right { text-align: right; font-size: 13px; line-height: 2; }
  .inv-to-label { font-size: 13px; margin-bottom: 2px; }
  .inv-to-name {
    font-size: 22px; font-weight: bold;
    border-bottom: 2px solid #333; padding-bottom: 4px;
    display: inline-block; padding-right: 16px; margin-bottom: 4px;
  }
  .inv-to-suffix { font-size: 15px; font-weight: normal; margin-left: 6px; }
  .inv-to-addr { font-size: 13px; margin-top: 4px; }

  .inv-from {
    text-align: right; font-size: 13px; line-height: 2; margin-bottom: 20px;
  }
  .inv-from-name { font-size: 18px; font-weight: bold; }

  .inv-table { width: 100%; border-collapse: collapse; margin-bottom: 8px; }
  .inv-table th {
    background: #2c3e50; color: #fff;
    padding: 8px 10px; font-weight: bold; text-align: center; font-size: 12px;
    white-space: nowrap;
  }
  .inv-table td {
    padding: 6px 10px; border-bottom: 1px solid #ddd;
    text-align: center; font-size: 13px; white-space: nowrap;
  }
  .inv-table td:nth-child(2) { text-align: left; }
  .inv-table td:nth-child(4), .inv-table td:nth-child(6) { text-align: right; }
  .inv-table td:last-child { text-align: right; }
  .inv-table tr.empty td { color: #ccc; height: 24px; }
  .inv-table tr.disc td { color: #c0392b; font-weight: bold; }

  .inv-summary { display: flex; justify-content: flex-end; margin-top: 8px; }
  .inv-summary table { border-collapse: collapse; font-size: 13px; width: 270px; }
  .inv-summary td { padding: 5px 12px; border-bottom: 1px solid #ddd; }
  .inv-summary td:first-child { font-weight: bold; }
  .inv-summary td:last-child { text-align: right; }
  .inv-summary .total td {
    border-top: 2px solid #333; border-bottom: 2px double #333;
    font-size: 17px; font-weight: bold; padding: 9px 12px;
  }

  .inv-footer {
    position: absolute; bottom: 30px; left: 68px; right: 68px;
    font-size: 13px; line-height: 1.8;
    border-top: 1px solid #999; padding-top: 10px;
  }
  .inv-footer b { font-size: 14px; }

  /* ===== ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° ===== */
  #loading {
    display: none; position: fixed; inset: 0; z-index: 9999;
    background: rgba(0,0,0,0.7);
    justify-content: center; align-items: center; flex-direction: column;
  }
  #loading.on { display: flex; }
  #loading .sp {
    width: 44px; height: 44px; border: 4px solid rgba(255,255,255,0.2);
    border-top-color: #e94560; border-radius: 50%;
    animation: spin 0.7s linear infinite;
  }
  #loading p { color: #fff; font-family: sans-serif; font-size: 15px; margin-top: 12px; }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* ===== ç”»åƒãƒ¢ãƒ¼ãƒ€ãƒ« ===== */
  #img-modal {
    display: none; position: fixed; inset: 0; z-index: 10000;
    background: rgba(0,0,0,0.92);
    flex-direction: column; justify-content: center; align-items: center;
    padding: 16px;
  }
  #img-modal.on { display: flex; }
  #img-modal .hint {
    color: #fff; font-size: 15px; font-family: sans-serif;
    margin-bottom: 10px; text-align: center;
  }
  #img-modal img {
    max-width: 94vw; max-height: 70vh;
    border: 2px solid #fff; border-radius: 4px;
    box-shadow: 0 4px 30px rgba(0,0,0,0.5);
  }
  #img-modal .modal-btns {
    margin-top: 14px; display: flex; gap: 10px; width: 100%; max-width: 340px;
  }
  #img-modal .modal-btns a, #img-modal .modal-btns button {
    flex: 1; padding: 12px; border: none; border-radius: 8px;
    font-size: 14px; font-weight: bold; font-family: sans-serif;
    text-align: center; text-decoration: none; cursor: pointer;
  }
  #img-modal .dl-btn { background: #e94560; color: #fff; }
  #img-modal .close-btn { background: #555; color: #fff; }
</style>
</head>
<body>

<!-- å…¥åŠ› -->
<div id="input-panel">
  <div class="input-row">
    <div class="field">
      <label>è«‹æ±‚åˆè¨ˆï¼ˆç¨è¾¼ãƒ»1å††å˜ä½OKï¼‰</label>
      <input type="number" id="inp-amount" placeholder="ä¾‹: 30000" min="1" step="1" inputmode="numeric">
    </div>
    <div class="field">
      <label>è«‹æ±‚æ—¥</label>
      <input type="date" id="inp-date">
    </div>
  </div>
  <div class="btn-row">
    <button id="btn-calc" onclick="calculate()">è¨ˆç®—ãƒ»ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
    <button id="btn-save" onclick="saveImage()" disabled>ğŸ“· ç”»åƒä¿å­˜</button>
  </div>
  <div id="msg"></div>
</div>

<!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
<div id="loading"><div class="sp"></div><p>ç”»åƒç”Ÿæˆä¸­...</p></div>

<!-- ç”»åƒãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="img-modal">
  <div class="hint">ğŸ“± ç”»åƒã‚’é•·æŠ¼ã—ã—ã¦ä¿å­˜</div>
  <img id="modal-img" src="" alt="è«‹æ±‚æ›¸">
  <div class="modal-btns">
    <a id="modal-dl" href="" download="è«‹æ±‚æ›¸.png" class="dl-btn">â¬‡ ä¿å­˜</a>
    <button class="close-btn" onclick="document.getElementById('img-modal').classList.remove('on')">âœ• é–‰ã˜ã‚‹</button>
  </div>
</div>

<!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
<div id="preview-wrap">
  <div id="invoice">
    <div class="inv-title">è«‹ã€€æ±‚ã€€æ›¸</div>

    <div class="inv-header">
      <div class="inv-header-left">
        <div class="inv-to-label">è«‹æ±‚å…ˆ:</div>
        <div class="inv-to-name">æ ªå¼ä¼šç¤¾ã€€ç¾é«˜å•†äº‹<span class="inv-to-suffix">å¾¡ä¸­</span></div>
        <div class="inv-to-addr">ç¦å³¶çœŒç™½æ²³å¸‚è±æ ¹é•·æœ¨åŸï¼•ï¼ï¼‘</div>
      </div>
      <div class="inv-header-right">
        è«‹æ±‚æ›¸ç•ªå·:<br>
        è«‹æ±‚æ—¥: <span id="disp-date">ï¼ˆæ—¥ä»˜ï¼‰</span>
      </div>
    </div>

    <div class="inv-from">
      <span class="inv-from-name">äº•ä¸Šã€€èŒ‰å¥ˆ</span><br>
      ä½æ‰€: ç¦å³¶çœŒç™½æ²³å¸‚ã¿ã•ã‹ï¼’ä¸ç›®ï¼’ï¼˜âˆ’ï¼‘ï¼‘<br>
      é›»è©±:<br>FAX:<br>ãƒ¡ãƒ¼ãƒ«:
    </div>

    <table class="inv-table">
      <thead>
        <tr>
          <th style="width:55px">å“ç›®ç•ªå·</th>
          <th>èª¬æ˜</th>
          <th style="width:50px">æ•°é‡</th>
          <th style="width:65px">å˜ä¾¡</th>
          <th style="width:55px">å‰²å¼•ç‡</th>
          <th style="width:80px">ä¾¡æ ¼</th>
        </tr>
      </thead>
      <tbody id="inv-tbody"></tbody>
    </table>

    <div class="inv-summary">
      <table>
        <tr><td>è«‹æ±‚æ›¸å°è¨ˆ</td><td id="d-sub">0</td></tr>
        <tr><td>ç¨ç‡</td><td>10%</td></tr>
        <tr><td>æ¶ˆè²»ç¨</td><td id="d-tax">0</td></tr>
        <tr><td>ãã®ä»–</td><td></td></tr>
        <tr><td>å‰é‡‘å—é ˜æ¸ˆã¿</td><td></td></tr>
        <tr class="total"><td>é›†è¨ˆ</td><td id="d-total">0</td></tr>
      </table>
    </div>

    <div class="inv-footer">
      <b>ãŠæŒ¯è¾¼ã¿å…ˆ: æ±é‚¦éŠ€è¡Œã€€ç™½æ²³è¥¿æ”¯åº—ã€€æ™®é€šã€€ï¼•ï¼˜ï¼—ï¼ï¼™ï¼</b>
    </div>
  </div>
</div>

<script>
const ITEMS = [
  { name: 'ãƒãƒƒã‚¯ãƒ¬ã‚¹',   price: 500 },
  { name: 'ãƒ–ãƒ¬ã‚¹ãƒ¬ãƒƒãƒˆ', price: 300 },
  { name: 'ã‚¹ãƒˆãƒ©ãƒƒãƒ—',   price: 100 },
  { name: 'ã—ãŠã‚Š',       price:  50 },
];
const ROWS = 12;

// ===== ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚° =====
function scaleInvoice() {
  const inv = document.getElementById('invoice');
  const wrap = document.getElementById('preview-wrap');
  const wrapW = wrap.clientWidth - 16;
  const invW = 794;
  const s = Math.min(1, wrapW / invW);
  inv.style.transform = `scale(${s})`;
  inv.style.transformOrigin = 'top center';
  // é«˜ã•èª¿æ•´ï¼ˆç¸®å°ã—ãŸåˆ†ã ã‘ä½™ç™½å‰Šã‚‹ï¼‰
  const invH = 1123;
  wrap.style.height = (invH * s + 24) + 'px';
}
window.addEventListener('DOMContentLoaded', () => {
  document.getElementById('inp-date').value = new Date().toISOString().slice(0, 10);
  scaleInvoice();
  // åˆæœŸè¡¨ç¤º
  renderTable([
    { name: 'ãƒ–ãƒ¬ã‚¹ãƒ¬ãƒƒãƒˆ', qty: 1, price: 300 },
    { name: 'ãƒãƒƒã‚¯ãƒ¬ã‚¹',   qty: 1, price: 500 },
    { name: 'ã‚¹ãƒˆãƒ©ãƒƒãƒ—',   qty: 1, price: 100 },
    { name: 'ã—ãŠã‚Š',       qty: 1, price:  50 },
  ], 900, 90, 990);
});
window.addEventListener('resize', scaleInvoice);

// ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
function fmt(n) { return n.toLocaleString('ja-JP'); }
function fmtDate(d) {
  return `${d.getFullYear()}å¹´${String(d.getMonth()+1).padStart(2,'0')}æœˆ${String(d.getDate()).padStart(2,'0')}æ—¥`;
}
function msg(text, ok) {
  const el = document.getElementById('msg');
  el.textContent = text;
  el.className = ok ? 'ok' : 'err';
}

// ===== é€†ç®— =====
function findSubtotal(total) {
  const a = Math.round(total / 1.1);
  for (let s = a - 2; s <= a + 2; s++) {
    if (s >= 0 && s + Math.round(s * 0.1) === total) return { sub: s, tax: Math.round(s * 0.1) };
  }
  const s = Math.floor(total / 1.1);
  return { sub: s, tax: total - s };
}

// ===== å‡ç­‰é…åˆ† + å€¤å¼•ã =====
function buildLines(subtotal) {
  if (subtotal <= 0) return [];
  const lines = [];
  const target = subtotal / ITEMS.length;
  const qtys = ITEMS.map(item => Math.max(1, Math.round(target / item.price)));
  let sum = ITEMS.reduce((s, item, i) => s + item.price * qtys[i], 0);

  let iter = 200;
  while (sum !== subtotal && iter-- > 0) {
    const diff = subtotal - sum;
    if (diff > 0) {
      let bi = -1, bd = Infinity;
      for (let i = 0; i < ITEMS.length; i++) {
        const nd = Math.abs(diff - ITEMS[i].price);
        if (ITEMS[i].price <= diff && nd < bd) { bd = nd; bi = i; }
      }
      if (bi === -1) break;
      qtys[bi]++; sum += ITEMS[bi].price;
    } else {
      let bi = -1, bd = Infinity;
      for (let i = 0; i < ITEMS.length; i++) {
        if (qtys[i] <= 0) continue;
        const nd = Math.abs(Math.abs(diff) - ITEMS[i].price);
        if (ITEMS[i].price <= Math.abs(diff) && nd < bd) { bd = nd; bi = i; }
      }
      if (bi === -1) {
        for (let i = ITEMS.length - 1; i >= 0; i--) {
          if (qtys[i] > 1) { qtys[i]--; sum -= ITEMS[i].price; break; }
        }
        continue;
      }
      qtys[bi]--; sum -= ITEMS[bi].price;
    }
  }

  for (let i = 0; i < ITEMS.length; i++) {
    if (qtys[i] > 0) lines.push({ name: ITEMS[i].name, qty: qtys[i], price: ITEMS[i].price });
  }

  const remain = subtotal - sum;
  if (remain > 0 && remain < 50) {
    const existing = lines.find(l => l.name === 'ã—ãŠã‚Š');
    if (existing) existing.qty += 1; else lines.push({ name: 'ã—ãŠã‚Š', qty: 1, price: 50 });
    lines.push({ name: 'å€¤å¼•ã', qty: 1, price: -(50 - remain), isDisc: true });
  }
  return lines;
}

// ===== ãƒ†ãƒ¼ãƒ–ãƒ«æç”» =====
function renderTable(lines, sub, tax, total) {
  const tbody = document.getElementById('inv-tbody');
  tbody.innerHTML = '';
  let r = 0;
  for (const l of lines) {
    const tr = document.createElement('tr');
    const lt = l.qty * l.price;
    if (l.isDisc) {
      tr.className = 'disc';
      tr.innerHTML = `<td></td><td>${l.name}</td><td></td><td></td><td></td><td>${fmt(lt)}</td>`;
    } else {
      tr.innerHTML = `<td></td><td>${l.name}</td><td>${l.qty}</td><td>${fmt(l.price)}</td><td></td><td>${fmt(lt)}</td>`;
    }
    tbody.appendChild(tr); r++;
  }
  for (; r < ROWS; r++) {
    const tr = document.createElement('tr'); tr.className = 'empty';
    tr.innerHTML = '<td></td><td></td><td></td><td></td><td></td><td>0</td>';
    tbody.appendChild(tr);
  }
  document.getElementById('d-sub').textContent = fmt(sub);
  document.getElementById('d-tax').textContent = fmt(tax);
  document.getElementById('d-total').textContent = fmt(total);
}

// ===== è¨ˆç®— =====
function calculate() {
  const amount = parseInt(document.getElementById('inp-amount').value, 10);
  const dateStr = document.getElementById('inp-date').value;
  if (!amount || amount < 1) { msg('âš  é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', false); return; }

  const { sub, tax } = findSubtotal(amount);
  const lines = buildLines(sub);
  const lineSum = lines.reduce((s, l) => s + l.qty * l.price, 0);
  if (lineSum !== sub) { msg('âš  è¨ˆç®—ã‚¨ãƒ©ãƒ¼', false); return; }

  if (dateStr) document.getElementById('disp-date').textContent = fmtDate(new Date(dateStr + 'T00:00:00'));
  renderTable(lines, sub, tax, amount);
  document.getElementById('btn-save').disabled = false;

  const disc = lines.find(l => l.isDisc);
  const dm = disc ? `ï¼ˆå€¤å¼•ã ${fmt(disc.price)}å††ï¼‰` : '';
  msg(`âœ“ å°è¨ˆÂ¥${fmt(sub)} + ç¨Â¥${fmt(tax)} = Â¥${fmt(amount)} ${dm}`, true);
}

// ===== ç”»åƒä¿å­˜ =====
function saveImage() {
  const inv = document.getElementById('invoice');
  const loader = document.getElementById('loading');
  loader.classList.add('on');

  // ã‚ªãƒ•ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã§ãƒ•ãƒ«ã‚µã‚¤ã‚ºã®è«‹æ±‚æ›¸ã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã—ã¦ã‚­ãƒ£ãƒ—ãƒãƒ£
  const clone = inv.cloneNode(true);
  clone.style.transform = 'none';
  clone.style.width = '794px';
  clone.style.height = '1123px';
  clone.style.position = 'fixed';
  clone.style.top = '-9999px';
  clone.style.left = '-9999px';
  clone.style.zIndex = '-1';
  document.body.appendChild(clone);

  setTimeout(() => {
    html2canvas(clone, {
      scale: 2,
      useCORS: true,
      width: 794,
      height: 1123,
      backgroundColor: '#ffffff'
    }).then(canvas => {
      document.body.removeChild(clone);
      loader.classList.remove('on');

      const dataUrl = canvas.toDataURL('image/png');
      document.getElementById('modal-img').src = dataUrl;
      document.getElementById('modal-dl').href = dataUrl;
      document.getElementById('img-modal').classList.add('on');
    }).catch(() => {
      document.body.removeChild(clone);
      loader.classList.remove('on');
      msg('âš  ç”»åƒç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ', false);
    });
  }, 50);
}
</script>
</body>
</html>
