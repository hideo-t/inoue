<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è«‹æ±‚æ›¸ç”Ÿæˆ - äº•ä¸ŠèŒ‰å¥ˆ â†’ ç¾é«˜å•†äº‹</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'Yu Mincho', 'Hiragino Mincho ProN', 'MS PMincho', serif;
    background: #f0f0f0; color: #222;
  }

  /* ===== å…¥åŠ›ãƒ‘ãƒãƒ« ===== */
  #input-panel {
    position: fixed; top: 0; left: 0; right: 0; z-index: 100;
    background: #1a1a2e; color: #fff; padding: 12px 16px;
    display: flex; align-items: center; gap: 16px; flex-wrap: wrap;
    box-shadow: 0 2px 12px rgba(0,0,0,0.3);
  }
  #input-panel label { font-size: 12px; font-family: sans-serif; display: block; margin-bottom: 4px; }
  #input-panel .input-group { flex: 1; min-width: 120px; }
  #input-panel input {
    padding: 10px 12px; border: none; border-radius: 8px;
    font-size: 16px; width: 100%; background: #fff; color: #222;
    -webkit-appearance: none;
  }
  #input-panel .btn-group {
    display: flex; gap: 8px; width: 100%;
  }
  #input-panel button {
    flex: 1; padding: 12px 16px; border: none; border-radius: 8px;
    font-size: 15px; font-weight: bold; cursor: pointer;
    font-family: sans-serif; transition: all 0.2s;
  }
  #btn-calc { background: #e94560; color: #fff; }
  #btn-calc:hover, #btn-calc:active { background: #c73652; }
  #btn-save { background: #0f3460; color: #fff; }
  #btn-save:hover, #btn-save:active { background: #16213e; }
  #btn-save:disabled { opacity: 0.4; cursor: not-allowed; }
  #msg-area { width: 100%; min-height: 18px; }
  #error-msg { color: #ff6b6b; font-size: 13px; font-family: sans-serif; }
  #success-msg { color: #51cf66; font-size: 13px; font-family: sans-serif; }
  #loading-overlay {
    display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.6); z-index: 9999;
    justify-content: center; align-items: center; flex-direction: column;
  }
  #loading-overlay.show { display: flex; }
  #loading-overlay .spinner {
    width: 48px; height: 48px; border: 4px solid rgba(255,255,255,0.3);
    border-top-color: #e94560; border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  #loading-overlay p {
    color: #fff; font-size: 16px; font-family: sans-serif;
    margin-top: 16px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* ===== ç”»åƒä¿å­˜ãƒ¢ãƒ¼ãƒ€ãƒ« ===== */
  #img-modal {
    display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    z-index: 10000; justify-content: center; align-items: center;
  }
  .img-modal-bg {
    position: absolute; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.85);
  }
  .img-modal-content {
    position: relative; z-index: 1; max-width: 92vw; max-height: 90vh;
    display: flex; flex-direction: column; align-items: center; gap: 12px;
    padding: 16px;
  }
  .img-modal-hint {
    color: #fff; font-size: 16px; font-family: sans-serif;
    text-align: center; margin: 0;
  }
  #img-modal-img {
    max-width: 88vw; max-height: 65vh;
    border: 3px solid #fff; border-radius: 4px;
    box-shadow: 0 4px 30px rgba(0,0,0,0.5);
    -webkit-user-select: none; user-select: none;
  }
  .img-modal-close {
    background: #555; color: #fff; border: none; border-radius: 8px;
    padding: 10px 32px; font-size: 15px; font-family: sans-serif;
    cursor: pointer; width: 100%; max-width: 300px;
  }
  .img-modal-dlbtn {
    background: #e94560; color: #fff; border: none; border-radius: 8px;
    padding: 12px 32px; font-size: 15px; font-family: sans-serif;
    cursor: pointer; text-decoration: none; text-align: center;
    width: 100%; max-width: 300px; display: block; font-weight: bold;
  }

  /* ===== è«‹æ±‚æ›¸ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ ===== */
  #preview-area {
    margin-top: 180px; padding: 10px;
    display: flex; justify-content: center;
    overflow-x: auto; -webkit-overflow-scrolling: touch;
  }

  @media (min-width: 769px) {
    #input-panel { padding: 16px 24px; gap: 20px; }
    #input-panel .input-group { flex: 0 0 auto; min-width: 180px; }
    #input-panel input { width: 180px; }
    #input-panel .btn-group { width: auto; }
    #input-panel button { flex: 0 0 auto; padding: 10px 28px; }
    #preview-area { margin-top: 90px; padding: 20px; }
  }

  @media (max-width: 768px) {
    #invoice {
      transform: scale(0.48); transform-origin: top left;
      margin-bottom: -150mm;
    }
    #preview-area {
      margin-top: 200px;
      justify-content: flex-start;
      padding: 10px 6px;
    }
  }
  @media (max-width: 480px) {
    #invoice {
      transform: scale(0.38); transform-origin: top left;
      margin-bottom: -180mm;
    }
    #preview-area { margin-top: 210px; }
  }
  #invoice {
    width: 210mm; min-height: 297mm; max-height: 297mm;
    background: #fff; padding: 18mm 18mm 15mm 18mm;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    position: relative; overflow: hidden;
  }

  .inv-title {
    text-align: center; font-size: 28px; font-weight: bold;
    letter-spacing: 12px; margin-bottom: 20px;
    border-bottom: 3px double #333; padding-bottom: 10px;
  }
  .inv-header {
    display: flex; justify-content: space-between; margin-bottom: 18px;
  }
  .inv-header-left { flex: 1; }
  .inv-header-right { text-align: right; font-size: 13px; line-height: 1.8; }
  .inv-to { font-size: 15px; margin-bottom: 4px; }
  .inv-to-name {
    font-size: 22px; font-weight: bold;
    border-bottom: 2px solid #333; padding-bottom: 4px;
    display: inline-block; padding-right: 20px; margin-bottom: 10px;
  }
  .inv-to-sama { font-size: 15px; font-weight: normal; margin-left: 8px; }
  .inv-from {
    text-align: right; font-size: 13px; line-height: 1.9; margin-bottom: 18px;
  }
  .inv-from-name { font-size: 17px; font-weight: bold; }

  .inv-table {
    width: 100%; border-collapse: collapse; margin-bottom: 10px; font-size: 13px;
  }
  .inv-table thead th {
    background: #2c3e50; color: #fff;
    padding: 7px 8px; font-weight: bold; text-align: center; font-size: 12px;
  }
  .inv-table tbody td {
    padding: 5px 8px; border-bottom: 1px solid #ddd; text-align: center;
  }
  .inv-table tbody td:nth-child(2) { text-align: left; }
  .inv-table tbody td:last-child { text-align: right; }
  .inv-table tbody td:nth-child(4),
  .inv-table tbody td:nth-child(6) { text-align: right; }
  .inv-table tbody tr.empty-row td { color: #ccc; height: 22px; }
  .inv-table tbody tr.discount-row td { color: #c0392b; font-weight: bold; }

  .inv-summary { display: flex; justify-content: flex-end; margin-top: 6px; }
  .inv-summary table { border-collapse: collapse; font-size: 13px; width: 260px; }
  .inv-summary td { padding: 5px 10px; border-bottom: 1px solid #ddd; }
  .inv-summary td:first-child { text-align: left; font-weight: bold; }
  .inv-summary td:last-child { text-align: right; }
  .inv-summary tr.total-row td {
    border-top: 2px solid #333; border-bottom: 2px double #333;
    font-size: 16px; font-weight: bold; padding: 8px 10px;
  }

  .inv-footer {
    position: absolute; bottom: 8mm; left: 18mm; right: 18mm;
    font-size: 12px; line-height: 1.8;
    border-top: 1px solid #999; padding-top: 10px;
  }
  .inv-footer-bank { font-weight: bold; font-size: 13px; }
</style>
</head>
<body>

<div id="input-panel">
  <div class="input-group">
    <label>è«‹æ±‚åˆè¨ˆé‡‘é¡ï¼ˆç¨è¾¼ãƒ»1å††å˜ä½OKï¼‰</label>
    <input type="number" id="inp-amount" placeholder="ä¾‹: 1234" min="1" step="1" inputmode="numeric">
  </div>
  <div class="input-group">
    <label>è«‹æ±‚æ—¥</label>
    <input type="date" id="inp-date">
  </div>
  <div class="btn-group">
    <button id="btn-calc" onclick="calculate()">è¨ˆç®—ãƒ»ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
    <button id="btn-save" onclick="saveImage()" disabled>ğŸ“· ç”»åƒä¿å­˜</button>
  </div>
  <div id="msg-area">
    <div id="error-msg"></div>
    <div id="success-msg"></div>
  </div>
</div>

<div id="loading-overlay"><div class="spinner"></div><p>ç”»åƒç”Ÿæˆä¸­...</p></div>

<div id="preview-area">
  <div id="invoice">
    <div class="inv-title">è«‹ã€€æ±‚ã€€æ›¸</div>
    <div class="inv-header">
      <div class="inv-header-left">
        <div class="inv-to">è«‹æ±‚å…ˆ:</div>
        <div class="inv-to-name">æ ªå¼ä¼šç¤¾ã€€ç¾é«˜å•†äº‹<span class="inv-to-sama">å¾¡ä¸­</span></div>
        <div style="font-size:13px; margin-top:4px;">ç¦å³¶çœŒç™½æ²³å¸‚è±æ ¹é•·æœ¨åŸï¼•ï¼ï¼‘</div>
      </div>
      <div class="inv-header-right">
        è«‹æ±‚æ›¸ç•ªå·: <br>
        è«‹æ±‚æ—¥: <span id="disp-date">ï¼ˆæ—¥ä»˜ï¼‰</span>
      </div>
    </div>
    <div class="inv-from">
      <span class="inv-from-name">äº•ä¸Šã€€èŒ‰å¥ˆ</span><br>
      ä½æ‰€: ç¦å³¶çœŒç™½æ²³å¸‚ã¿ã•ã‹ï¼’ä¸ç›®ï¼’ï¼˜âˆ’ï¼‘ï¼‘<br>
      é›»è©±:<br>FAX:<br>ãƒ¡ãƒ¼ãƒ«:
    </div>

    <table class="inv-table">
      <thead>
        <tr>
          <th style="width:60px">å“ç›®ç•ªå·</th>
          <th>èª¬æ˜</th>
          <th style="width:55px">æ•°é‡</th>
          <th style="width:70px">å˜ä¾¡</th>
          <th style="width:60px">å‰²å¼•ç‡</th>
          <th style="width:80px">ä¾¡æ ¼</th>
        </tr>
      </thead>
      <tbody id="inv-tbody"></tbody>
    </table>

    <div class="inv-summary">
      <table>
        <tr><td>è«‹æ±‚æ›¸å°è¨ˆ</td><td id="disp-subtotal">0</td></tr>
        <tr><td>ç¨ç‡</td><td>10%</td></tr>
        <tr><td>æ¶ˆè²»ç¨</td><td id="disp-tax">0</td></tr>
        <tr><td>ãã®ä»–</td><td></td></tr>
        <tr><td>å‰é‡‘å—é ˜æ¸ˆã¿</td><td></td></tr>
        <tr class="total-row"><td>é›†è¨ˆ</td><td id="disp-total">0</td></tr>
      </table>
    </div>

    <div class="inv-footer">
      <div class="inv-footer-bank">
        ãŠæŒ¯è¾¼ã¿å…ˆ: æ±é‚¦éŠ€è¡Œã€€ç™½æ²³è¥¿æ”¯åº—ã€€æ™®é€šã€€ï¼•ï¼˜ï¼—ï¼ï¼™ï¼
      </div>
    </div>
  </div>
</div>

<script>
const ITEMS = [
  { name: 'ãƒãƒƒã‚¯ãƒ¬ã‚¹',   price: 500 },
  { name: 'ãƒ–ãƒ¬ã‚¹ãƒ¬ãƒƒãƒˆ', price: 300 },
  { name: 'ã‚¹ãƒˆãƒ©ãƒƒãƒ—',   price: 100 },
  { name: 'ã—ãŠã‚Š',       price:  50 },
];
const TOTAL_ROWS = 12;
const TAX_RATE = 0.1;

window.addEventListener('DOMContentLoaded', () => {
  document.getElementById('inp-date').value = new Date().toISOString().slice(0, 10);
  renderInvoice([
    { name: 'ãƒ–ãƒ¬ã‚¹ãƒ¬ãƒƒãƒˆ', qty: 1, price: 300 },
    { name: 'ãƒãƒƒã‚¯ãƒ¬ã‚¹',   qty: 1, price: 500 },
    { name: 'ã‚¹ãƒˆãƒ©ãƒƒãƒ—',   qty: 1, price: 100 },
    { name: 'ã—ãŠã‚Š',       qty: 1, price:  50 },
  ], 900, 90, 990);
});

function formatDate(d) {
  return `${d.getFullYear()}å¹´${String(d.getMonth()+1).padStart(2,'0')}æœˆ${String(d.getDate()).padStart(2,'0')}æ—¥`;
}
function formatNum(n) { return n.toLocaleString('ja-JP'); }

/**
 * ç¨è¾¼é‡‘é¡ â†’ å°è¨ˆãƒ»ç¨ã‚’é€†ç®—
 */
function findSubtotal(total) {
  const approx = Math.round(total / 1.1);
  for (let s = approx - 2; s <= approx + 2; s++) {
    if (s < 0) continue;
    if (s + Math.round(s * TAX_RATE) === total) {
      return { subtotal: s, tax: Math.round(s * TAX_RATE) };
    }
  }
  // å®Œå…¨ä¸€è‡´ãªã— â†’ åˆ‡ã‚Šæ¨ã¦ã§å°è¨ˆæ±ºå®šã€ç«¯æ•°ã¯ç¨ã«å¸å
  const sub = Math.floor(total / 1.1);
  return { subtotal: sub, tax: total - sub };
}

/**
 * å°è¨ˆ â†’ æ˜ç´°è¡Œã‚’ç”Ÿæˆ
 * å„å•†å“ã®é‡‘é¡ãŒã»ã¼å‡ç­‰ã«ãªã‚‹ã‚ˆã†æ•°é‡é…åˆ†ã—ã€ç«¯æ•°ã¯å€¤å¼•ãè¡Œã§èª¿æ•´
 */
function buildLines(subtotal) {
  if (subtotal <= 0) return [];

  const lines = [];
  const targetPerItem = subtotal / ITEMS.length;

  // å„å•†å“ã«ã»ã¼å‡ç­‰ãªé‡‘é¡ã«ãªã‚‹ã‚ˆã†æ•°é‡ã‚’å‰²ã‚Šå½“ã¦
  let qtys = ITEMS.map(item => {
    const q = Math.max(1, Math.round(targetPerItem / item.price));
    return q;
  });

  // ç¾åœ¨ã®åˆè¨ˆã‚’è¨ˆç®—
  let currentSum = ITEMS.reduce((s, item, i) => s + item.price * qtys[i], 0);

  // åˆè¨ˆãŒå°è¨ˆã«è¿‘ã¥ãã‚ˆã†å¾®èª¿æ•´ï¼ˆå®‰ã„å•†å“ã®æ•°é‡ã‚’å¢—æ¸›ï¼‰
  // è¶…éã—ã¦ã„ã‚‹å ´åˆ: é«˜é¡å“ã‹ã‚‰æ•°é‡ã‚’æ¸›ã‚‰ã™
  // ä¸è¶³ã—ã¦ã„ã‚‹å ´åˆ: å®‰ã„å“ã‹ã‚‰æ•°é‡ã‚’å¢—ã‚„ã™
  let maxIter = 200;
  while (currentSum !== subtotal && maxIter-- > 0) {
    const diff = subtotal - currentSum;

    if (diff > 0) {
      // ä¸è¶³ â†’ è¿½åŠ ã§ãã‚‹æœ€é©ãªå•†å“ã‚’æ¢ã™
      let bestIdx = -1, bestDiff = Infinity;
      for (let i = 0; i < ITEMS.length; i++) {
        const newDiff = Math.abs(diff - ITEMS[i].price);
        if (ITEMS[i].price <= diff && newDiff < bestDiff) {
          bestDiff = newDiff;
          bestIdx = i;
        }
      }
      if (bestIdx === -1) break; // ã“ã‚Œä»¥ä¸Šè¿½åŠ ã§ããªã„
      qtys[bestIdx]++;
      currentSum += ITEMS[bestIdx].price;
    } else {
      // è¶…é â†’ æ¸›ã‚‰ã›ã‚‹æœ€é©ãªå•†å“ã‚’æ¢ã™
      let bestIdx = -1, bestDiff = Infinity;
      for (let i = 0; i < ITEMS.length; i++) {
        if (qtys[i] <= 0) continue;
        const newDiff = Math.abs(Math.abs(diff) - ITEMS[i].price);
        if (ITEMS[i].price <= Math.abs(diff) && newDiff < bestDiff) {
          bestDiff = newDiff;
          bestIdx = i;
        }
      }
      if (bestIdx === -1) {
        // æ¸›ã‚‰ã›ã‚‹å•†å“ãŒãªã„å ´åˆã€æ•°é‡>1ã®æœ€å®‰å“ã‹ã‚‰1ã¤æ¸›ã‚‰ã™
        for (let i = ITEMS.length - 1; i >= 0; i--) {
          if (qtys[i] > 1) { qtys[i]--; currentSum -= ITEMS[i].price; break; }
        }
        if (currentSum === subtotal) break;
        continue;
      }
      qtys[bestIdx]--;
      currentSum -= ITEMS[bestIdx].price;
    }
  }

  // å•†å“è¡Œã‚’ç”Ÿæˆï¼ˆæ•°é‡>0ã®ã¿ï¼‰
  for (let i = 0; i < ITEMS.length; i++) {
    if (qtys[i] > 0) {
      lines.push({ name: ITEMS[i].name, qty: qtys[i], price: ITEMS[i].price });
    }
  }

  // ç«¯æ•°å‡¦ç†: currentSum != subtotal ã®å ´åˆã€ã—ãŠã‚Šè¿½åŠ  + å€¤å¼•ã
  const remain = subtotal - currentSum;
  if (remain > 0 && remain < 50) {
    const discountAmt = 50 - remain;
    const existing = lines.find(l => l.name === 'ã—ãŠã‚Š');
    if (existing) {
      existing.qty += 1;
    } else {
      lines.push({ name: 'ã—ãŠã‚Š', qty: 1, price: 50 });
    }
    lines.push({ name: 'å€¤å¼•ã', qty: 1, price: -discountAmt, isDiscount: true });
  }

  return lines;
}

function renderInvoice(lines, subtotal, tax, total) {
  const tbody = document.getElementById('inv-tbody');
  tbody.innerHTML = '';
  let rowCount = 0;

  for (const line of lines) {
    const tr = document.createElement('tr');
    const lineTotal = line.qty * line.price;

    if (line.isDiscount) {
      tr.className = 'discount-row';
      tr.innerHTML = `
        <td></td>
        <td>${line.name}</td>
        <td></td>
        <td></td>
        <td></td>
        <td>${formatNum(lineTotal)}</td>
      `;
    } else {
      tr.innerHTML = `
        <td></td>
        <td>${line.name}</td>
        <td>${line.qty}</td>
        <td>${formatNum(line.price)}</td>
        <td></td>
        <td>${formatNum(lineTotal)}</td>
      `;
    }
    tbody.appendChild(tr);
    rowCount++;
  }

  for (let i = rowCount; i < TOTAL_ROWS; i++) {
    const tr = document.createElement('tr');
    tr.className = 'empty-row';
    tr.innerHTML = '<td></td><td></td><td></td><td></td><td></td><td>0</td>';
    tbody.appendChild(tr);
  }

  document.getElementById('disp-subtotal').textContent = formatNum(subtotal);
  document.getElementById('disp-tax').textContent = formatNum(tax);
  document.getElementById('disp-total').textContent = formatNum(total);
}

function calculate() {
  const errEl = document.getElementById('error-msg');
  const sucEl = document.getElementById('success-msg');
  errEl.textContent = ''; sucEl.textContent = '';

  const amount = parseInt(document.getElementById('inp-amount').value, 10);
  const dateStr = document.getElementById('inp-date').value;

  if (!amount || amount < 1) {
    errEl.textContent = 'âš  é‡‘é¡ã‚’1ä»¥ä¸Šã®æ•´æ•°ã§å…¥åŠ›ã—ã¦ãã ã•ã„';
    return;
  }

  const { subtotal, tax } = findSubtotal(amount);
  const lines = buildLines(subtotal);

  // æ¤œç®—
  const lineSum = lines.reduce((s, l) => s + l.qty * l.price, 0);
  if (lineSum !== subtotal) {
    errEl.textContent = `âš  å†…éƒ¨è¨ˆç®—ã‚¨ãƒ©ãƒ¼: æ˜ç´°åˆè¨ˆ${lineSum} â‰  å°è¨ˆ${subtotal}`;
    return;
  }

  if (dateStr) {
    document.getElementById('disp-date').textContent = formatDate(new Date(dateStr + 'T00:00:00'));
  }

  renderInvoice(lines, subtotal, tax, amount);
  document.getElementById('btn-save').disabled = false;

  const discLine = lines.find(l => l.isDiscount);
  const discMsg = discLine ? `ï¼ˆå€¤å¼•ã ${formatNum(discLine.price)}å††ï¼‰` : '';
  sucEl.textContent = `âœ“ å°è¨ˆ Â¥${formatNum(subtotal)} + ç¨ Â¥${formatNum(tax)} = Â¥${formatNum(amount)} ${discMsg}`;
}

function saveImage() {
  const el = document.getElementById('invoice');
  const panel = document.getElementById('input-panel');
  const loader = document.getElementById('loading-overlay');

  loader.querySelector('p').textContent = 'ç”»åƒç”Ÿæˆä¸­...';
  loader.classList.add('show');

  // ãƒ¢ãƒã‚¤ãƒ«ã®CSS transformã‚’ä¸€æ™‚è§£é™¤
  const origTransform = el.style.transform;
  const origTransformOrigin = el.style.transformOrigin;
  const origMarginBottom = el.style.marginBottom;
  const origMaxHeight = el.style.maxHeight;
  const origMinHeight = el.style.minHeight;

  el.style.transform = 'none';
  el.style.transformOrigin = 'top left';
  el.style.marginBottom = '0';
  el.style.maxHeight = '297mm';
  el.style.minHeight = '297mm';

  panel.style.display = 'none';
  window.scrollTo(0, 0);

  function restore() {
    el.style.transform = origTransform;
    el.style.transformOrigin = origTransformOrigin;
    el.style.marginBottom = origMarginBottom;
    el.style.maxHeight = origMaxHeight;
    el.style.minHeight = origMinHeight;
    panel.style.display = 'flex';
    loader.classList.remove('show');
  }

  setTimeout(() => {
    html2canvas(el, {
      scale: 3,
      useCORS: true,
      width: el.scrollWidth,
      height: el.scrollHeight,
      windowWidth: 810,
      scrollX: 0,
      scrollY: 0,
      backgroundColor: '#ffffff'
    }).then(canvas => {
      restore();

      // ç”»åƒã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º â†’ é•·æŠ¼ã—ä¿å­˜ã‚’ä¿ƒã™
      const dataUrl = canvas.toDataURL('image/png');

      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã§ç”»åƒè¡¨ç¤º
      let modal = document.getElementById('img-modal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'img-modal';
        modal.innerHTML = `
          <div class="img-modal-bg" onclick="closeImgModal()"></div>
          <div class="img-modal-content">
            <p class="img-modal-hint">ğŸ“± ç”»åƒã‚’é•·æŠ¼ã—ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„</p>
            <img id="img-modal-img" src="" alt="è«‹æ±‚æ›¸">
            <button class="img-modal-close" onclick="closeImgModal()">âœ• é–‰ã˜ã‚‹</button>
            <a id="img-modal-dl" href="" download="è«‹æ±‚æ›¸_ç¾é«˜å•†äº‹å®›_äº•ä¸ŠèŒ‰å¥ˆ.png" class="img-modal-dlbtn">â¬‡ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</a>
          </div>
        `;
        document.body.appendChild(modal);
      }
      document.getElementById('img-modal-img').src = dataUrl;
      document.getElementById('img-modal-dl').href = dataUrl;
      modal.style.display = 'flex';
    }).catch(() => {
      restore();
      document.getElementById('error-msg').textContent = 'âš  ç”»åƒç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ';
    });
  }, 100);
}

function closeImgModal() {
  const modal = document.getElementById('img-modal');
  if (modal) modal.style.display = 'none';
}
</script>
</body>
</html>
